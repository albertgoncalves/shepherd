#!/usr/bin/env bash

export WD=$PWD
export JSPATH="$WD/client"
export GOPATH="$WD/server"
export HOST
export PORT="8085"

if [ "$(uname -s)" = "Darwin" ]; then
    alias ls="ls --color=auto"
    alias ll="ls -l"
    HOST=$(ipconfig getifaddr en0 || ipconfig getifaddr en1)
else
    alias open="xdg-open"
    HOST=$(hostname -i | cut -d " " -f 1)
fi

if [ ! -d "$GOPATH/bin" ]; then
    mkdir "$GOPATH/bin"
fi

if [ ! -f "$GOPATH/.goinit" ]; then
    go get -v golang.org/x/lint/golint
    touch "$GOPATH/.goinit"
fi

gofmts() {
    if gofmt -w -s -e "$1"; then
        awk '{ gsub(/\t/, "    "); print }' < "$1" > tmp
        cat tmp > "$1"
        rm tmp
    fi
}

golint() {
    "$GOPATH/bin/golint" "$1" \
        | sed -n -e '/exported .* should have comment.* or be unexported/!p' \
        | sed -n -e '/struct field Id should be ID/!p' \
        | sed -n -e "/don't use ALL_CAPS in Go names; use CamelCase/!p"
}

goall() {
    cd "$GOPATH" || exit
    find . -type f -name '*.go' \
        -not -path "*golang.org*" \
        -exec bash -c 'echo "$0"; golint "$0"; gofmts "$0"' {} \;
}

export -f gofmts
export -f golint
export -f goall

if [ ! -f "$JSPATH/.jsinit" ]; then
    cd "$JSPATH" || exit
    npm install --save-dev jshint
    touch "$JSPATH/.jsinit"
    cd "$WD" || exit
fi

sedtrailing () {
    sed -i 's/[ \t]\+$//' "$1"
}

export -f sedtrailing

jsall () {
    find "$JSPATH/src" -type f -name '*.html' -exec bash -c '
        echo "$1"
        tidy -config "$JSPATH/.tidyrc" -q -m "$1"
        sedtrailing "$1"
    ' bash {} \;
    find "$JSPATH/src" -type f -name '*.js' -exec bash -c '
        echo "$1"
        "$JSPATH/node_modules/jshint/bin/jshint" \
            --verbose \
            -c "$JSPATH/.jshintrc" \
            "$1"
        clang-format -i "$1"
    ' bash {} \;
}

export -f jsall
