#!/usr/bin/env bash

export WD=$PWD

if [ "$(uname -s)" = "Darwin" ]; then
    alias ls="ls --color=auto"
    alias ll="ls -l"
else
    alias open="xdg-open"
fi

if [ ! -f "$WD/.jsinit" ]; then
    npm install --save-dev jshint
    touch "$WD/.jsinit"
fi

fmt () {
    for x in "$WD"/src/*.html; do
        printf "$ tidy %s\n" "$x"
        tidy -config "$WD/.tidyrc" -q -m "$x"
        sed -i 's/[ \t]\+$//' "$x"
    done
    find "$WD/src" -type f -name '*.js' -exec bash -c '
        printf "$ jshint %s\n" "$1"
        "$WD/node_modules/jshint/bin/jshint" -c "$WD/.jshintrc" "$1"
        printf "$ clang-format %s\n" "$1"
        clang-format -i "$1"
    ' bash {} \;
}

export -f fmt
